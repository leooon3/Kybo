name: Build iOS for Sideloadly

on:
  push:
    branches: ["main", "dev"]
  workflow_dispatch:
    inputs:
      environment:
        description: "Seleziona Ambiente (Flavor)"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - prod

jobs:
  build_ios_unsigned:
    name: Build iOS (${{ inputs.environment }})
    runs-on: macos-latest

    defaults:
      run:
        working-directory: ./client

    steps:
      - uses: actions/checkout@v4

      # 1. Setup Flutter
      - uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: "3.38.5" # O la tua versione
          cache: true

      # 2. Install Dependencies
      - name: Install Dependencies
        run: flutter pub get

      # 3. INIEZIONE CONFIGURAZIONE FIREBASE (Fix Crash)
      # Sceglie il segreto in base all'input 'environment'
      - name: Inject GoogleService-Info.plist
        run: |
          if [[ "${{ inputs.environment }}" == "prod" ]]; then
             echo "ðŸš€ Building for PROD - Using Prod Config"
             echo "${{ secrets.IOS_FIREBASE_CONFIG_PROD }}" | base64 --decode > ios/Runner/GoogleService-Info.plist
          else
             echo "ðŸ› ï¸ Building for DEV - Using Dev Config"
             echo "${{ secrets.IOS_FIREBASE_CONFIG_DEV }}" | base64 --decode > ios/Runner/GoogleService-Info.plist
          fi

      # 4. BUILD IOS (No Codesign - Force Manual)
      - name: Build iOS App Bundle
        run: |
          # Impostiamo ENV a 'dev' se l'input Ã¨ vuoto (es. trigger via push)
          BUILD_ENV="${{ inputs.environment }}"
          if [ -z "$BUILD_ENV" ]; then BUILD_ENV="dev"; fi

          echo "Building for environment: $BUILD_ENV"

          flutter build ios --release --no-codesign --dart-define=ENV=$BUILD_ENV -- \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGN_STYLE=Manual

      # 5. CREAZIONE IPA MANUALE
      # Flutter crea un .app, ma Sideloadly vuole un .ipa.
      # Un .ipa Ã¨ solo una cartella "Payload" zippata.
      - name: Package IPA for Sideloadly
        run: |
          mkdir Payload
          mv build/ios/iphoneos/Runner.app Payload/
          zip -r kybo_${{ inputs.environment }}.ipa Payload

      # 6. UPLOAD ARTIFACT
      # Scaricherai questo file da GitHub per darlo a Sideloadly
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: kybo-ios-${{ inputs.environment }}
          path: client/kybo_${{ inputs.environment }}.ipa
